name: CI Pipeline

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: 18

jobs:
  # ===================== DETECT CHANGES =====================
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      category: ${{ steps.filter.outputs.category }}
      coupon: ${{ steps.filter.outputs.coupon }}
      graphql: ${{ steps.filter.outputs.graphql }}
      order: ${{ steps.filter.outputs.order }}
      product: ${{ steps.filter.outputs.product }}
      ticket: ${{ steps.filter.outputs.ticket }}

    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - auth-service/**
            category:
              - category-service/**
            coupon:
              - coupon-service/**
            graphql:
              - graphql-gateway/**
            order:
              - order-service/**
            product:
              - product-service/**
            ticket:
              - ticket-service/**

  # ===================== LINT =====================
  lint:
    name: Lint Codebase
    runs-on: ubuntu-latest
    needs: detect-changes
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - run: yarn install --frozen-lockfile
      - run: yarn lint

  # ===================== FORMAT =====================
  format:
    name: Check Format
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - run: yarn install --frozen-lockfile
      - run: yarn format:check

  # ===================== BUILD =====================
  build:
    name: Build Services
    runs-on: ubuntu-latest
    needs: [format, detect-changes]
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: auth-service
            should_run: ${{ needs.detect-changes.outputs.auth == 'true' }}
          - service: category-service
            should_run: ${{ needs.detect-changes.outputs.category == 'true' }}
          - service: coupon-service
            should_run: ${{ needs.detect-changes.outputs.coupon == 'true' }}
          - service: graphql-gateway
            should_run: ${{ needs.detect-changes.outputs.graphql == 'true' }}
          - service: order-service
            should_run: ${{ needs.detect-changes.outputs.order == 'true' }}
          - service: product-service
            should_run: ${{ needs.detect-changes.outputs.product == 'true' }}
          - service: ticket-service
            should_run: ${{ needs.detect-changes.outputs.ticket == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - run: yarn install --frozen-lockfile

      - name: Build Service
        if: matrix.should_run
        run: yarn workspace @3asoftwares/${{ matrix.service }} build

  # ===================== TEST =====================
  test:
    name: Test Services
    runs-on: ubuntu-latest
    needs: [build, detect-changes]
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: auth-service
            should_run: ${{ needs.detect-changes.outputs.auth == 'true' }}
          - service: category-service
            should_run: ${{ needs.detect-changes.outputs.category == 'true' }}
          - service: coupon-service
            should_run: ${{ needs.detect-changes.outputs.coupon == 'true' }}
          - service: graphql-gateway
            should_run: ${{ needs.detect-changes.outputs.graphql == 'true' }}
          - service: order-service
            should_run: ${{ needs.detect-changes.outputs.order == 'true' }}
          - service: product-service
            should_run: ${{ needs.detect-changes.outputs.product == 'true' }}
          - service: ticket-service
            should_run: ${{ needs.detect-changes.outputs.ticket == 'true' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - run: yarn install --frozen-lockfile

      - name: Test Service
        if: matrix.should_run
        run: yarn workspace @3asoftwares/${{ matrix.service }} test -- --passWithNoTests

  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - run: yarn install --frozen-lockfile

      - uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==========================================================================
  # CI Success Gate
  # ==========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test, build, sonarqube]
    if: always()
    steps:
      - name: Check CI status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.sonarqube.result }}" != "success" ]; then
            echo "CI failed!"
            exit 1
          fi
          echo "CI passed successfully!"

  # ==========================================================================
  # Version Bump (main branch only, after PR merge)
  # ==========================================================================
  version-bump:
    name: Version Bump
    runs-on: ubuntu-latest
    needs: [ci-success]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine bump type from commit
        id: bump-type
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit: $COMMIT_MSG"

          if echo "$COMMIT_MSG" | grep -qiE "^(breaking|major)"; then
            echo "bump=major" >> $GITHUB_OUTPUT
          elif echo "$COMMIT_MSG" | grep -qiE "^(feat|feature)"; then
            echo "bump=minor" >> $GITHUB_OUTPUT
          else
            echo "bump=patch" >> $GITHUB_OUTPUT
          fi

      - name: Bump version
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          yarn version --${{ steps.bump-type.outputs.bump }} --no-git-tag-version
          NEW=$(node -p "require('./package.json').version")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT
          echo "new=$NEW" >> $GITHUB_OUTPUT

      - name: Commit and tag
        run: |
          git add package.json yarn.lock
          git commit -m "chore: bump version to v${{ steps.version.outputs.new }} [skip ci]"
          # Delete tag locally and remotely if it already exists
          if git rev-parse "v${{ steps.version.outputs.new }}" >/dev/null 2>&1; then
            git tag -d "v${{ steps.version.outputs.new }}"
            git push --delete origin "v${{ steps.version.outputs.new }}"
          fi
          git tag -a "v${{ steps.version.outputs.new }}" -m "Release v${{ steps.version.outputs.new }}"
          git push origin main --follow-tags

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.new }}
          name: v${{ steps.version.outputs.new }}
          body: |
            **Version:** ${{ steps.version.outputs.current }} â†’ ${{ steps.version.outputs.new }}
            **Type:** ${{ steps.bump-type.outputs.bump }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
